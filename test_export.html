<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<title>Test Export</title>
<body style="font-family:sans-serif;background:#f5f5f5;text-align:center">
  <h3>Минимальный тест экспорта SVG → PNG</h3>
  <svg id="hoodie-svg" viewBox="0 0 2674 3000" width="446" height="500" xmlns="http://www.w3.org/2000/svg" style="background:#fff;border:1px solid #ddd">
    <rect x="400" y="400" width="1874" height="2200" fill="#9adbe2"/>
  </svg>
  <div style="margin:16px"><button id="savePngBtn">Сохранить PNG</button></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('savePngBtn')?.addEventListener('click', savePNG);
});

function savePNG() {
  const svgEl = document.getElementById('hoodie-svg');
  if (!svgEl) { alert('SVG не найден'); return; }
  const OUT_W = 2674, OUT_H = 3000;

  const cloned = svgEl.cloneNode(true);
  cloned.setAttribute('width', OUT_W);
  cloned.setAttribute('height', OUT_H);
  cloned.setAttribute('viewBox', `0 0 ${OUT_W} ${OUT_H}`);

  const serializer = new XMLSerializer();
  let svgString = serializer.serializeToString(cloned);
  if (!svgString.includes('xmlns="http://www.w3.org/2000/svg"')) {
    svgString = svgString.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
  }

  const svgBlob = new Blob([svgString], {type:'image/svg+xml;charset=utf-8'});
  const svgUrl  = URL.createObjectURL(svgBlob);

  const canvas = document.createElement('canvas');
  canvas.width = OUT_W; canvas.height = OUT_H;
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.onload = () => {
    ctx.drawImage(img, 0, 0, OUT_W, OUT_H);
    URL.revokeObjectURL(svgUrl);
    canvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `GORSNOW_hoodie_${OUT_W}x${OUT_H}.png`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }, 'image/png');
  };
  img.onerror = (e) => {
    URL.revokeObjectURL(svgUrl);
    console.error('Ошибка загрузки SVG в <img>:', e);
    alert('Экспорт не удался. Смотри Console.');
  };
  img.src = svgUrl;
}
</script>
</body>
</html>